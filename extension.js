// Generated by CoffeeScript 1.7.1
(function() {
  var message, search;

  message = function(msg) {};

  chrome.runtime.onMessage.addListener(function(request, sender, send_response) {
    console.log('Sender', sender);
    if (sender.tab) {
      console.log("From a content script tab url: " + sender.tab.url);
      chrome.storage.sync.set({
        'url': sender.tab.url
      }, function() {
        return message("URL SAVED");
      });
      chrome.storage.sync.get('url', function(result) {
        return console.log("Get back from storage :" + result.url);
      });
    } else {
      console.log("From the extension");
    }
    if (request.greeting === "hello") {
      sendResponse({
        farewell: "goodbye"
      });
    }

    /*
     * test messages
     */
    return chrome.tabs.sendMessage(sender.tab.id, {
      type: 'test',
      data: {
        one: 'two'
      }
    }, function(response) {
      return console.log("Finished Search Results");
    });
  });


  /*
   * takes in a query string
   */

  search = function(query, tab_id) {
    return chrome.storage.sync.get(null, function(result) {
      var search_results, tokens;
      console.log('Searching');
      tokens = query.split(/[^0-9A-Za-z]/);
      search_results = _.foldl(result, function(memo, item) {
        var matches;
        matches = _.intersection(result.keywords, result.tags, tokens).length;
        if (matches) {
          memo.push(result);
        }
        return memo;
      }, []);
      return chrome.tabs.sendMessage(tab_id, {
        search_results: search_results
      }, function(response) {
        return console.log("Finished Search Results");
      });
    });
  };

}).call(this);
